<Sysmon schemaversion="4.92">
  <HashAlgorithms>sha256,imphash</HashAlgorithms>
  
  <EventFiltering>
    
    <!-- DISABLE NOISE -->
    <ProcessTerminate onmatch="exclude"/>
    
    <!-- ============================================ -->
    <!-- DETECTION: Scheduled Task Creation          -->
    <!-- ============================================ -->
    <RuleGroup name="T1053.005_ScheduledTaskCreation" groupRelation="or">

      <!-- Detecting schtasks.exe creation -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">schtasks.exe</Image>
        <CommandLine condition="contains any">/create;/tn;/tr</CommandLine>
      </ProcessCreate>

      <!-- Detecting schedule task creation with WMI -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <CommandLine condition="contains any">PS_ScheduledTask;Invoke-CimMethod</CommandLine>
      </ProcessCreate>

      <!-- Detecting PowerShell Register-ScheduledTask -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <CommandLine condition="contains">Register-ScheduledTask</CommandLine>
      </ProcessCreate>

      <!-- Scheduled Task with elevated privileges -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <CommandLine condition="contains all">Register-ScheduledTask;-RunLevel;Highest</CommandLine>
      </ProcessCreate>

      <!-- Scheduled Task with BUILTIN\Administrators -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <CommandLine condition="contains all">Register-ScheduledTask;BUILTIN\Administrators</CommandLine>
      </ProcessCreate>

    </RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: Credential Dumping (T1003.001)   -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_ProcessCreation" groupRelation="or">
      
      <!-- PowerShell with MiniDump keywords -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <CommandLine condition="contains any">MiniDump;minidump;DumpWriteDump;Out-Minidump</CommandLine>
      </ProcessCreate>
      
      <!-- rundll32 with comsvcs.dll MiniDump -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">rundll32.exe</Image>
        <CommandLine condition="contains any">comsvcs.dll,MiniDump;comsvcs.dll,minidump</CommandLine>
      </ProcessCreate>
      
      <!-- ProcDump targeting LSASS -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">procdump.exe</Image>
        <CommandLine condition="contains">lsass</CommandLine>
      </ProcessCreate>

      <ProcessCreate onmatch="include">
        <Image condition="end with">procdump64.exe</Image>
        <CommandLine condition="contains">lsass</CommandLine>
      </ProcessCreate>

      <!-- Any procdump with full memory dump flag -->
      <ProcessCreate onmatch="include">
        <Image condition="contains">procdump</Image>
        <CommandLine condition="contains">-ma</CommandLine>
      </ProcessCreate>

    </RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: Network Activity                 -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_NetworkActivity" groupRelation="or">
      <NetworkConnect onmatch="include">
        <Image condition="end with">powershell.exe</Image>
      </NetworkConnect>
      <NetworkConnect onmatch="include">
        <Image condition="end with">pwsh.exe</Image>
      </NetworkConnect>
    </RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: LSASS Memory Access              -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_LSASS_Access" groupRelation="or">
      
      <!-- Monitor all LSASS access -->
      <ProcessAccess onmatch="include">
        <TargetImage condition="end with">lsass.exe</TargetImage>
      </ProcessAccess>
      
      <!-- Exclude legitimate Windows processes -->
      <ProcessAccess onmatch="exclude">
        <SourceImage condition="is">C:\Windows\System32\svchost.exe</SourceImage>
      </ProcessAccess>

      <ProcessAccess onmatch="exclude">
        <SourceImage condition="is">C:\Windows\System32\wininit.exe</SourceImage>
      </ProcessAccess>

      <ProcessAccess onmatch="exclude">
        <SourceImage condition="is">C:\Windows\System32\csrss.exe</SourceImage>
      </ProcessAccess>

      <ProcessAccess onmatch="exclude">
        <SourceImage condition="contains">\Windows Defender\</SourceImage>
      </ProcessAccess>

      <ProcessAccess onmatch="exclude">
        <SourceImage condition="contains">MsMpEng.exe</SourceImage>
      </ProcessAccess>

      <ProcessAccess onmatch="exclude">
        <SourceImage condition="contains">\Microsoft\EdgeUpdate\</SourceImage>
      </ProcessAccess>
      
    </RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: Dump File Creation               -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_DumpFiles" groupRelation="or">
      
      <!-- Monitor .dmp file creation -->
      <FileCreate onmatch="include">
        <TargetFilename condition="end with">.dmp</TargetFilename>
      </FileCreate>
      
      <!-- Exclude legitimate crash dumps -->
      <FileCreate onmatch="exclude">
        <TargetFilename condition="begin with">C:\Windows\Minidump\</TargetFilename>
      </FileCreate>
      
      <FileCreate onmatch="exclude">
        <TargetFilename condition="begin with">C:\ProgramData\Microsoft\Windows\WER\</TargetFilename>
      </FileCreate>
      
      <FileCreate onmatch="exclude">
        <Image condition="is">C:\Windows\System32\WerFault.exe</Image>
      </FileCreate>
      
    </RuleGroup>

    <!-- ============================================ -->
    <!-- NOISE REDUCTION                             -->
    <!-- ============================================ -->
    <RuleGroup name="NoiseReduction" groupRelation="or">
      
      <!-- Exclude Splunk forwarder processes -->
      <ProcessCreate onmatch="exclude">
        <ParentImage condition="is">C:\Program Files\SplunkUniversalForwarder\bin\splunkd.exe</ParentImage>
      </ProcessCreate>

      <ProcessCreate onmatch="exclude">
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
      </ProcessCreate>

      <ProcessCreate onmatch="exclude">
        <Image condition="begin with">C:\Program Files (x86)\Microsoft\Edge\</Image>
      </ProcessCreate>

      <ProcessCreate onmatch="exclude">
        <Image condition="is">C:\Windows\SystemApps\Microsoft.Windows.Search_cw5n1h2txyewy\SearchApp.exe</Image>
      </ProcessCreate>

      <ProcessCreate onmatch="exclude">
        <Image condition="is">C:\Windows\System32\backgroundTaskHost.exe</Image>
      </ProcessCreate>
      
      <!-- Exclude Splunk and Edge file creation -->
      <FileCreate onmatch="exclude">
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
      </FileCreate>

      <FileCreate onmatch="exclude">
        <Image condition="begin with">C:\Program Files (x86)\Microsoft\Edge\</Image>
      </FileCreate>
      
      <!-- Exclude Splunk network connections -->
      <NetworkConnect onmatch="exclude">
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
      </NetworkConnect>
      
      <NetworkConnect onmatch="exclude">
        <Image condition="begin with">C:\Program Files (x86)\Microsoft\Edge\</Image>
      </NetworkConnect>
      
    </RuleGroup>
    
  </EventFiltering>
</Sysmon>