<Sysmon schemaversion="4.90">
  <HashAlgorithms>sha256,imphash</HashAlgorithms>
  
  <EventFiltering>
    
    <!-- === GLOBAL ENABLES (MANDATORY ORDER) === -->
    <ProcessCreate onmatch="include"/>
    <FileCreate onmatch="include"/>  <!-- ✅ ADDED THIS -->
    <ImageLoad onmatch="include"/>
    <ProcessTerminate onmatch="include"/>
    <NetworkConnect onmatch="exclude"/>
    
    <!-- === T1059 : AutoIt Interpreter Abuse === -->
    <RuleGroup groupRelation="or">
      
      <!-- 1. AutoIt executing any .au3 script -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">AutoIt3.exe|AutoIt3_x64.exe</Image>
        <CommandLine condition="contains">.au3</CommandLine>
      </ProcessCreate>
      
      <!-- 2. AutoIt using execution switches -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">AutoIt3.exe|AutoIt3_x64.exe</Image>
        <CommandLine condition="contains any">/AutoIt3ExecuteScript;/AutoIt3ExecuteLine</CommandLine>
      </ProcessCreate>
      
      <!-- 3. Office app spawning AutoIt -->
      <ProcessCreate onmatch="include">
        <ParentImage condition="end with">winword.exe|excel.exe|powerpnt.exe|outlook.exe</ParentImage>
        <Image condition="end with">AutoIt3.exe|AutoIt3_x64.exe</Image>
      </ProcessCreate>
      
      <!-- 4. AutoIt spawning shells -->
      <ProcessCreate onmatch="include">
        <ParentImage condition="end with">AutoIt3.exe|AutoIt3_x64.exe</ParentImage>
        <Image condition="end with">cmd.exe|powershell.exe|pwsh.exe</Image>
      </ProcessCreate>
      
      <!-- 5. AutoIt spawning calc.exe (recon indicator) -->
      <ProcessCreate onmatch="include">
        <ParentImage condition="end with">AutoIt3.exe|AutoIt3_x64.exe</ParentImage>
        <Image condition="end with">calc.exe</Image>
      </ProcessCreate>
      
      <!-- 6. Malicious file execution from Temp -->
      <ProcessCreate onmatch="include">
        <Image condition="contains">\Temp\</Image>
        <Image condition="end with">.exe</Image>
      </ProcessCreate>
      
    </RuleGroup>
    
    <!-- === NETWORK: AutoIt Download Activity === -->
    <RuleGroup name="AutoIt Network Downloads" groupRelation="or">
      
      <!-- ✅ CATCH InetGet() - THIS WAS MISSING! -->
      <NetworkConnect onmatch="include">
        <Image condition="end with">AutoIt3.exe|AutoIt3_x64.exe</Image>
      </NetworkConnect>
      
    </RuleGroup>
    
    <!-- === FILE: Malicious File Creation === -->
    <RuleGroup groupRelation="or">
      
      <!-- Files written to Temp by AutoIt -->
      <FileCreate onmatch="include">
        <Image condition="end with">AutoIt3.exe|AutoIt3_x64.exe</Image>
        <TargetFilename condition="contains">\Temp\</TargetFilename>
      </FileCreate>
      
      <!-- Any .exe dropped to Temp -->
      <FileCreate onmatch="include">
        <TargetFilename condition="begin with">C:\Users\</TargetFilename>
        <TargetFilename condition="contains">\Temp\</TargetFilename>  <!-- ✅ FIXED CASE -->
        <TargetFilename condition="end with">.exe</TargetFilename>  <!-- ✅ FIXED TYPO -->
      </FileCreate>
      
    </RuleGroup>
    
    <!-- === NOISE REDUCTION === -->
    
    <!-- Exclude Splunk Forwarder -->
    <ProcessCreate onmatch="exclude">
      <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\bin\</Image>
    </ProcessCreate>
    <ProcessCreate onmatch="exclude">
      <Image condition="begin with">D:\Program Files\SplunkUniversalForwarder\bin\</Image>
    </ProcessCreate>
    <ProcessCreate onmatch="exclude">
      <ParentImage condition="contains">splunkd.exe</ParentImage>
    </ProcessCreate>
    
    <!-- Exclude Windows Defender legitimate activity -->
    <NetworkConnect onmatch="exclude">
      <Image condition="begin with">C:\ProgramData\Microsoft\Windows Defender\</Image>
    </NetworkConnect>
    <FileCreate onmatch="exclude">
      <Image condition="begin with">C:\ProgramData\Microsoft\Windows Defender\</Image>
    </FileCreate>
    
    <!-- Exclude Edge/OneDrive noise -->
    <NetworkConnect onmatch="exclude">
      <Image condition="contains any">msedge.exe;OneDrive.exe;SearchApp.exe;msedgewebview2.exe</Image>
    </NetworkConnect>
    
    <!-- Exclude ImageLoad noise (optional but recommended) -->
    <ImageLoad onmatch="exclude">
      <Image condition="contains">splunk</Image>
    </ImageLoad>
    
  </EventFiltering>
</Sysmon>