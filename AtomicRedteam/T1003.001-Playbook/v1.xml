<Sysmon schemaversion="4.90">
  <HashAlgorithms>sha256,imphash</HashAlgorithms>
  
  <EventFiltering>
    
    <!-- DISABLE NOISE -->
    <ProcessTerminate onmatch="exclude"/>
    
    <!-- ============================================ -->
    <!-- DETECTION: Process Creation                 -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_ProcessCreation" groupRelation="or">
      
      <!-- PowerShell with MiniDump keywords -->
      <ProcessCreate onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <CommandLine condition="contains any">MiniDump;minidump;DumpWriteDump;Out-Minidump</CommandLine>
      </ProcessCreate>
      
      <!-- rundll32 with comsvcs.dll -->
      <ProcessCreate onmatch="include" >
        <CommandLine condition="contains">comsvcs.dll,MiniDump</CommandLine>
        <CommandLine condition="contains">comsvcs.dll,minidump</CommandLine>

        
      </ProcessCreate>
      
      <!-- ProcDump detecting LSASS -->
<ProcessCreate onmatch="include" >
  <Image condition="end with">procdump.exe</Image>
  <CommandLine condition="contains">lsass</CommandLine>
</ProcessCreate>

<ProcessCreate onmatch="include">
  <Image condition="end with">procdump64.exe</Image>
  <CommandLine condition="contains">lsass</CommandLine>
</ProcessCreate>

<!-- Alternative: catch any procdump with -ma flag -->
<ProcessCreate onmatch="include">
  <Image condition="contains">procdump</Image>
  <CommandLine condition="contains">-ma</CommandLine>
</ProcessCreate>

    </RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: Network Activity                 -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_NetworkActivity" groupRelation="or">
      <NetworkConnect onmatch="include">
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">pwsh.exe</Image>
      </NetworkConnect>
    </RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: LSASS Memory Access              -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_LSASS_Access" groupRelation="or">
  
  <!-- Include: All LSASS access -->
  <ProcessAccess onmatch="include">
    <TargetImage condition="end with">lsass.exe</TargetImage>
  </ProcessAccess>

  <!-- Exclude: Low privilege query-only access -->
  <ProcessAccess onmatch="exclude">
    <GrantedAccess condition="is any">0x1000;0x40;0x1400</GrantedAccess>
  </ProcessAccess>
  
  <!-- Exclude: Core Windows system processes -->
  <ProcessAccess onmatch="exclude">
    <SourceImage condition="is any">
      C:\Windows\System32\svchost.exe;
      C:\Windows\System32\wininit.exe;
      C:\Windows\System32\csrss.exe;
      C:\Windows\System32\services.exe;
      C:\Windows\System32\CompatTelRunner.exe
    </SourceImage>
  </ProcessAccess>
  
  <!-- Exclude: Windows Defender -->
  <ProcessAccess onmatch="exclude">
    <SourceImage condition="contains">\Windows Defender\</SourceImage>
  </ProcessAccess>
  
  <ProcessAccess onmatch="exclude">
    <SourceImage condition="contains">MsMpEng.exe</SourceImage>
  </ProcessAccess>
  
  <!-- Exclude: Microsoft Edge Update -->
  <ProcessAccess onmatch="exclude">
    <SourceImage condition="contains">\Microsoft\EdgeUpdate\</SourceImage>
  </ProcessAccess>
  
</RuleGroup>

    <!-- ============================================ -->
    <!-- DETECTION: Dump File Creation               -->
    <!-- ============================================ -->
    <RuleGroup name="T1003.001_DumpFiles" groupRelation="or">
      
      <!-- PowerShell creating .dmp -->
      <FileCreate onmatch="include" >
        <TargetFilename condition="end with">.dmp</TargetFilename>

      </FileCreate>
      
      <!-- Exclude legitimate crash dumps -->
      <FileCreate onmatch="exclude">
        <TargetFilename condition="begin with">C:\Windows\Minidump\</TargetFilename>
      </FileCreate>
      
      <FileCreate onmatch="exclude">
        <TargetFilename condition="begin with">C:\ProgramData\Microsoft\Windows\WER\</TargetFilename>
      </FileCreate>
      
      <FileCreate onmatch="exclude">
        <Image condition="is">C:\Windows\System32\WerFault.exe</Image>
      </FileCreate>
      
    </RuleGroup>

    <!-- ============================================ -->
    <!-- NOISE REDUCTION                             -->
    <!-- ============================================ -->
    <RuleGroup name="NoiseReduction" groupRelation="or">
      
      
      <ProcessCreate onmatch="exclude">
        <ParentImage condition="is">C:\Program Files\SplunkUniversalForwarder\bin\splunkd.exe</ParentImage>
      </ProcessCreate>

      <ProcessCreate onmatch="exclude">
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
  
        <Image condition="begin with">C:\Program Files (x86)\Microsoft\Edge\</Image>

        <Image condition="is">C:\Windows\SystemApps\Microsoft.Windows.Search_cw5n1h2txyewy\SearchApp.exe</Image>

        <Image condition="is">C:\Windows\System32\backgroundTaskHost.exe</Image>
      </ProcessCreate>
      
      <FileCreate onmatch="exclude">
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
        <Image condition="begin with">C:\Program Files (x86)\Microsoft\Edge\</Image>
      </FileCreate>
      
      <NetworkConnect onmatch="exclude">
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
      </NetworkConnect>
      
      <NetworkConnect onmatch="exclude">
        <Image condition="begin with">C:\Program Files (x86)\Microsoft\Edge\</Image>
      </NetworkConnect>
      
    </RuleGroup>
    
  </EventFiltering>
</Sysmon>